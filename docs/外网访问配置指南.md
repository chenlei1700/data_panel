# 外网访问配置指南

## 🌐 配置路由器端口转发

### 步骤1: 获取内网IP
```bash
# Windows 查看内网IP
ipconfig

# 找到你的内网IP，通常是：
# 192.168.1.xxx 或 192.168.0.xxx 或 10.0.0.xxx
```

### 步骤2: 路由器管理界面配置
1. 浏览器访问路由器管理界面（通常是 192.168.1.1 或 192.168.0.1）
2. 登录路由器管理员账号
3. 找到 "端口转发" 或 "虚拟服务器" 设置
4. 添加新的转发规则：
   - **服务名称**: data_panel_server
   - **外部端口**: 5004 (或其他你想要的端口，如8080)
   - **内部IP**: 你的电脑内网IP (如 192.168.1.100)
   - **内部端口**: 5004 (服务器实际端口)
   - **协议**: TCP

### 步骤3: 获取公网IP
```bash
# 在浏览器中访问以下任一网站获取公网IP
# https://www.whatismyip.com/
# https://ipinfo.io/
# 或命令行：curl ifconfig.me
```

## � Windows防火墙配置

### 方法1: 通过控制面板
1. 打开 "控制面板" → "系统和安全" → "Windows Defender 防火墙"
2. 点击 "高级设置"
3. 选择 "入站规则" → "新建规则"
4. 选择 "端口" → 下一步
5. 选择 "TCP" → "特定本地端口" → 输入 "5004"
6. 选择 "允许连接"
7. 应用到所有网络类型
8. 名称：data_panel_server
9. 完成

### 方法2: 命令行配置
```bash
# 以管理员身份运行命令提示符，执行：
netsh advfirewall firewall add rule name="data_panel_server" dir=in action=allow protocol=TCP localport=5004
```

## �🔒 安全配置

### 生产环境启动
```bash
# 使用提供的生产环境启动脚本
cd data_panel
start_production.bat

# 或手动启动
cd data_panel/api/server
python production_server.py
```

### 安全特性
- ✅ 关闭Debug模式
- ✅ 添加安全响应头
- ✅ 访问日志记录
- ✅ 健康检查端点
- ✅ 错误信息脱敏

## 📊 验证外网访问

### 内网测试
```bash
# 在内网其他设备上测试
http://你的内网IP:5004
http://你的内网IP:5004/health
```

### 外网测试
```bash
# 在外网设备上测试
http://你的公网IP:5004
http://你的公网IP:5004/health
```

## 🌍 域名配置（可选）

### 1. 申请域名
- 推荐：阿里云、腾讯云、Cloudflare等
- 选择合适的域名，如：myquant.com

### 2. DNS解析配置
```
A记录: myquant.com → 你的公网IP
A记录: api.myquant.com → 你的公网IP
```

### 3. 域名访问
- 主站：http://myquant.com:5004
- API：http://api.myquant.com:5004

## 🔧 高级配置

### 反向代理（推荐生产环境）
如果想去掉端口号，可以配置Nginx反向代理：

```nginx
server {
    listen 80;
    server_name myquant.com;
    
    location / {
        proxy_pass http://localhost:5004;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

### HTTPS配置
```bash
# 使用Let's Encrypt免费SSL证书
# 1. 安装certbot
# 2. 申请证书
certbot --nginx -d myquant.com
```

## 🐛 常见问题排查

### 1. 无法外网访问
- ✅ 检查路由器端口转发是否正确
- ✅ 检查Windows防火墙规则
- ✅ 确认公网IP是否正确
- ✅ 检查运营商是否封禁了端口

### 2. 服务器启动失败
```bash
# 检查端口是否被占用
netstat -an | findstr :5004

# 检查数据文件是否存在
dir data\kpl_market_sentiment_data.csv
dir strategy\showhtml\server\up_limit_df.csv
```

### 3. 访问日志位置
```
logs/access_YYYYMMDD.log
```

## 📞 技术支持

### 日志检查
```bash
# 查看服务器日志
type logs\access_*.log

# 查看错误日志
python production_server.py
```

### 性能监控
- 访问：http://你的IP:5004/health
- 监控CPU和内存使用情况
- 检查数据缓存状态

---

**重要提示**：
1. 🔐 生产环境务必修改默认密钥
2. 🛡️ 定期检查访问日志
3. 🔄 确保数据文件及时更新
4. 📈 监控服务器性能和可用性
